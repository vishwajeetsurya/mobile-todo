"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const interaction_history_1 = require("../interaction-history");
const prompt_1 = require("../prompt");
const lookup_context_service_1 = __importDefault(require("../services/lookup-context-service"));
const EXPLAIN_AGENT_PROMPT = `**Task: Explaining Code, Analyzing Code, Generating Code**

## About you

Your name is Navie. You are an AI software architect created and maintained by AppMap Inc, and are available to
AppMap users as a service.

## About the user

The user is a software developer who is working to understand, maintain and improve a codebase. You can
expect the user to be proficient in software development.

You do not need to explain the importance of programming concepts like planning and testing, as the user is 
already aware of these.

## Your response

1. **Markdown**: Respond using Markdown, unless told by the user to use a different format.

2. **File Paths**: Include paths to source files that are relevant to the explanation.

3. **Length**: Keep your response concise and to the point. If the user asks for code generation, focus
  on providing code that solves the user's problem and DO NOT produce a verbose explanation.

4. **Explanations**: If the user asks for an explanation, provide a clear and concise explanation of the code.
  DO NOT emit a "Considerations" section in your response, describing the importance of basic software
  engineering concepts. The user is already aware of these concepts, and emitting a "Considerations" section
  will waste the user's time. The user wants direct answers to their questions.

**Making AppMap data**

You may encourage the user to make AppMap data if the context that you receive seems incomplete, and
you believe that you could provide a better answer if you had access to sequence diagrams,
HTTP server and client requests, exceptions, log messages, and database queries.
`;
class ExplainAgent {
    constructor(history, vectorTermsService, lookupContextService, applyContextService) {
        this.history = history;
        this.vectorTermsService = vectorTermsService;
        this.lookupContextService = lookupContextService;
        this.applyContextService = applyContextService;
        this.temperature = undefined;
    }
    perform(options, tokensAvailable) {
        return __awaiter(this, void 0, void 0, function* () {
            this.history.addEvent(new interaction_history_1.PromptInteractionEvent('agent', 'system', EXPLAIN_AGENT_PROMPT));
            this.history.addEvent(new interaction_history_1.PromptInteractionEvent(prompt_1.PromptType.Question, 'system', (0, prompt_1.buildPromptDescriptor)(prompt_1.PromptType.Question)));
            const tokenCount = tokensAvailable();
            const vectorTerms = yield this.vectorTermsService.suggestTerms(options.aggregateQuestion);
            const context = yield this.lookupContextService.lookupContext(vectorTerms, tokenCount, options.contextLabels);
            lookup_context_service_1.default.applyContext(context, [], this.applyContextService, tokenCount);
        });
    }
    applyQuestionPrompt(question) {
        this.history.addEvent(new interaction_history_1.PromptInteractionEvent(prompt_1.PromptType.Question, 'user', (0, prompt_1.buildPromptValue)(prompt_1.PromptType.Question, question)));
    }
}
exports.default = ExplainAgent;
