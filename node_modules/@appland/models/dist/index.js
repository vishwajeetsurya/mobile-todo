var Pe=Object.defineProperty;var Ie=(r,e,t)=>e in r?Pe(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var m=(r,e,t)=>(Ie(r,typeof e!="symbol"?e+"":e,t),t);var c={ANALYSIS_FINDING:"analysis-finding",DATABASE:"database",QUERY:"query",HTTP:"http",EXTERNAL_ROUTE:"external-route",EXTERNAL_SERVICE:"external-service",ROUTE:"route",PACKAGE:"package",CLASS:"class",FUNCTION:"function"};function Fe(r){return[c.HTTP,c.DATABASE,c.EXTERNAL_SERVICE].includes(r)}function P(r,e=[]){let{parent:t}=r;if(t&&!Fe(t.type)){P(t,e);let s;switch(r.parent.type){case c.PACKAGE:s="/";break;case c.CLASS:s="::";break;default:s="->"}r.type===c.FUNCTION&&(s="static"in r&&r.static?".":"#"),e.push(s)}return e.push(r.name),e}import Ve from"crypto-js/sha256.js";var Ue=/(?:(?:#|--).*?(?=\r|\n|$))|(?:\/\*(?:[^/]|\/[^*])*?(?:\*\/|\/\*.*))/gi,ve={single_quotes:/'(?:[^']|'')*?(?:'(?!'))/g,double_quotes:/"(?:[^"]|"")*?(?:\\".*|"(?!"))/g,dollar_quotes:/(\$(?!\d)[^$]*?\$).*?(?:\1|$)/g,uuids:/\{?(?:[0-9a-fA-F]-*){32}\}?/g,numeric_literals:/-?\b(?:[0-9]+\.)?[0-9]+([eE][+-]?[0-9]+)?\b/g,boolean_literals:/\b(?:true|false|null)\b/gi,hexadecimal_literals:/0x[0-9a-fA-F]+/g,oracle_quoted_strings:/q'\[.*?(?:\]'|$)|q'\{.*?(?:\}'|$)|q'<.*?(?:>'|$)|q'\(.*?(?:\)'|$)/g},ee={mysql:/'|"|\/\*|\*\//,mysql2:/'|"|\/\*|\*\//,postgres:/'|\/\*|\*\/|\$(?!\?)/,sqlite:/'|\/\*|\*\//,cassandra:/'|\/\*|\*\//,oracle:/'|\/\*|\*\//,oracle_enhanced:/'|\/\*|\*\//},ke={fallback:Object.keys(ve),mysql:["single_quotes","double_quotes","numeric_literals","boolean_literals","hexadecimal_literals"],postgres:["single_quotes","dollar_quotes","uuids","numeric_literals","boolean_literals"],sqlite:["single_quotes","numeric_literals","boolean_literals","hexadecimal_literals"],oracle:["single_quotes","oracle_quoted_strings","numeric_literals"],cassandra:["single_quotes","uuids","numeric_literals","boolean_literals","hexadecimal_literals"]},Me="?";function T(r){let s=`(?:${ke[r].map(n=>ve[n].source).flat().join(")|(?:")})`;return new RegExp(s,"gi")}var ze=T("mysql"),He=T("postgres"),Qe=T("sqlite"),Be=T("oracle"),De=T("cassandra"),Ge=T("fallback");function Je(r,e){return ee[e]?ee[e].test(r):ee.mysql.test(r)}function A(r,e){let t;switch(e){case"mysql":case"mysql2":t=ze;break;case"postgres":t=He;break;case"sqlite":t=Qe;break;case"oracle":case"oracle_enhanced":t=Be;break;case"cassandra":t=De;break;default:t=Ge}let s=r.replace(t,Me).replace(Ue,"");return Je(s,e)&&(s=r),s}import Ke from"@appland/sql-parser";var I=class extends Error{constructor(e,t){super(e),this.sql=t}toString(){return`${this.message}: ${this.sql}`}};var xe=!1,F;function Xe(r){F&&console.warn(`Replacing existing sqlErrorHandler ${F} with ${r}`),F=r}function te(r){if(F){F(r);return}xe||(console.debug("No SQL error handler was set. SQL errors will be logged to the console."),console.debug("Set a SQL error handling by calling setSQLErrorHandler(handler)."),xe=!0),console.debug(r)}function U(r){let e=r.replace(/\s+returning\s+\*/i,"");try{return Ke(e)}catch(t){return te(new I(t.message,e)),null}}function L(r){let e=U(r);if(!e)return null;let t=[],s=[],n=[],i=0;function o(f){if(f===null)return;let g=["type","variant"].map(Z=>f[Z]).filter(Boolean).join("."),b=d[g];b||(b=a),(Array.isArray(b)?b:[b]).forEach(Z=>Z(f))}function a(f){if(f===null){console.warn(`Ignoring request to parse null statement in query ${r}`);return}let D=["type","variant","name","value"];Object.keys(f).filter(g=>!D.includes(g)).map(g=>f[g]).forEach(g=>{Array.isArray(g)?g.forEach(o):typeof g=="object"?o(g):typeof g=="string"||typeof g=="boolean"||console.warn(`Unrecognized subexpression: ${typeof g} ${g}`)})}function l(f,D){f.forEach(g=>{let b=D[g];Array.isArray(b)?b.forEach(o):typeof b=="object"?o(b):console.warn(`Unrecognized subexpression: ${b}`)})}let h=()=>{};function u(f){f.format==="table"&&n.push(f.name),l(["columns"],f)}function E(f){return()=>{t.push(f)}}let d={"literal.text":h,"literal.decimal":h,"identifier.star":f=>s.push(f.name),"identifier.column":f=>s.push(f.name),"identifier.table":f=>n.push(f.name),"identifier.expression":u,"statement.select":[E("select"),a],"statement.insert":[E("insert"),a],"statement.update":[E("update"),a],"statement.delete":[E("delete"),a],"statement.pragma":h,"map.join":[f=>{i+=f.map.length},a]};o(e);function x(f){return[...new Set(f)]}return{actions:x(t).sort(),tables:x(n).sort(),columns:x(s).sort(),joinCount:i}}function se(r,e){let t=U(r);return t?JSON.stringify(t,(s,n)=>{if(n===null)return null;switch(n.type){case"variable":case"literal":return{type:"variable"};default:return n}}):A(r,e)}import{Buffer as _e}from"buffer";function We(){try{return process.env.APPMAP_LOG_EXTERNAL_PATH==="true"}catch(r){if(r instanceof ReferenceError)return!1;console.warn(r)}}var Ye=We(),q=(r,e)=>Object.prototype.hasOwnProperty.call(r,e);function Lt(r){return!r||r.class==="FalseClass"||r.class==="Array"&&r.value==="[]"||r.value===""}function Nt(r){return!!(r.http_server_request||r.codeObject.labels.has("command"))}function Ze(r){return typeof r!="string"?"":r.slice(0,1).toUpperCase()+r.slice(1).toLowerCase()}function et(r){if(q(r,"http_server_request")===!1)return null;let e=r.http_server_request.request_method,t=r.http_server_request.path_info,s;try{let n=new URL(t,"http://hostname");s=`${e} ${n.pathname}`}catch{s="HTTP Request"}return s}var tt=new Set(["insert","update","select","delete","alter","create","drop","rename","truncate","replace","savepoint","release","rollback","lock","unlock","set","start","call","delete","do","perform","handler","load","purge","reset","prepare","execute","deallocate","xa"]);function ie(r){let e=[...r.trimLeft()];e.length>0&&e[0]==="("&&e.shift();let t=0,s=e.reduce((i,o)=>(o==="("&&(t+=1),t===0&&i.push(o),o===")"&&(t-=1),i),[]).join(""),n=null;return s.search(/\s/)===-1?n=s:n=s.replace(/[^\w]+/g," ").toLowerCase().split(" ").find(i=>tt.has(i)),["SQL",Ze(n)||null].join(" ")}function st(r){return q(r,"sql_query")===!1?null:ie(r.sql_query.normalized_sql||r.sql_query.sql||"")}function ae(r){let e=et(r);return e||(e=st(r)),e}function rt(r){let e={...r};return Object.keys(r).forEach(t=>{let s=r[t];Array.isArray(s)?e[t]=new Set(s):s instanceof Set?e[t]=s:s&&typeof s=="object"?e[t]=rt(s):e[t]=s}),e}var nt={github:r=>{let e=r.url.match(/github.com[:|/]?(.*).git/);if(!e||e.length<=1)return null;let t=typeof r.lineNumber=="number"?`#L${r.lineNumber}`:"";return`https://github.com/${e[1]}/blob/${r.commit}/${r.path}${t}`}};function Pt(r,e,t="master",s=null){if(r&&e){let n={url:r,path:e,lineNumber:s,commit:t},i=Object.values(nt);for(let o=0;o<i.length;o+=1){let a=i[o](n);if(a)return a}}return null}var G=1,J=16,re=r=>/[A-Z]/.exec(r)===null?J:G,it=r=>r.length<=2?null:{firstCase:re(r[0]),secondCase:re(r[1])},ne=r=>{let e=r.length;if(e<1)return[];let t=it(r);if(!t)return[r];let{firstCase:s,secondCase:n}=t,i=[],o=!1;for(let a=2;a<e;a+=1){let l=re(r[a]);if(l===G){if(s===J||n===J){let h=r.slice(0,a);i.push(h),i.push(...ne(r.slice(a))),o=!0;break}}else if(l===J&&s===G&&n===G){let h=r.slice(0,a-1);i.push(h),i.push(...ne(r.slice(a-1))),o=!0;break}}return o||i.push(r),i};function It(r){let e=ae(r);return e||r.toString()}function Ft(r){let e=[];return(r||"").split(/[$.:#\-_]/).forEach(s=>{e.push(...ne(s))}),e}function p(r,e,t){Object.hasOwnProperty.call(r,"$hidden")||Object.defineProperty(r,"$hidden",{enumerable:!1,writable:!1,value:{}}),Object.defineProperty(r.$hidden,e,{enumerable:!1,writable:!0,...t})}function qe(r,e){let t={};function s(n,i,o,a){i[n]||(i[n]={}),i[n][o]||(i[n][o]=[]),i[n][o].push(a)}return r.codeObjects.filter(n=>n.labels.size).forEach(n=>{Array.from(n.labels).forEach(i=>{s(i,t,n.type,n)})}),e.filter(n=>n.isCall()&&n.labels.size).forEach(n=>{Array.from(n.labels).forEach(i=>{s(i,t,"event",n)})}),t}var k=r=>JSON.stringify(r).length;function Ut(r){if(r.httpServerRequest)return"http";let{sqlQuery:e}=r;if(e){let t=L(e),s=["sql",t.action,...t.tables].filter(Boolean).join("");return Ve(s).toString()}return r.toString()}function oe(r,e){let t=0,s=0;for(;;){let n=r[t],i=e[s];if(!n&&!i)return;if(typeof n>"u"){r.push(null),t+=1,s+=1;continue}if(typeof i>"u"){e.push(null),t+=1,s+=1;continue}let o=n.identityHash,a=i.identityHash;if(o!==a){let l=0;for(let u=t+1;u<r.length;u+=1)l+=r[u].identityHash===o?1:0;let h=0;for(let u=s+1;u<e.length;u+=1)h+=e[u].identityHash===o?1:0;l>=h?e.splice(s,0,null):l<h&&r.splice(t,0,null)}t+=1,s+=1}}function Se(r){return r.filter(e=>e.isCall()&&!e.parent)}function we(r){return r==null?!0:Array.isArray(r)||typeof r=="string"?r.length===0:r instanceof Set||r instanceof Map?r.size===0:typeof r=="object"?Object.values(r).every(we):!1}function X(r,e){return r.reduce((t,s)=>{let n=e[s];return we(n)||(n instanceof Set?t[s]=[...n]:t[s]=n),t},{})}function Ce(r){return _e.from(r,"base64").toString("utf-8")}function kt(r){return _e.from(r,"utf-8").toString("base64").replace(/=/g,"").replace(/_/g,"/").replace(/-/g,"+")}var Oe=new Set;function j(r,e,t){!Ye||Oe.has(r)||(Oe.add(r),process.stderr.write(`${e}: ${r}`),t&&process.stderr.write(` (${t})`),process.stderr.write(`
`))}function $e(r,e=[]){if(!r)return{isLocal:!1};/^[a-zA-Z]:[\\/]/.test(r)&&(r=r.slice(2));let[t,s]=r.split(":");if(r.includes("<")&&j(r,"remote","includes <"),(!s||isNaN(parseInt(s,10)))&&t.split(/[\\/]/).length===1)return j(r,"remote","no line number and no path separator chars"),{isLocal:!1};if(t.length===0)return j(r,"remote","zero-length"),{isLocal:!1};if(t.charAt(0)==="<")return j(r,"remote","starts with <"),{isLocal:!1};if(["/","\\"].includes(t.charAt(0)))return j(r,"remote",`starts with ${t.charAt(0)}`),{isLocal:!1};/^\.[/\\]/.test(t)&&(t=t.substring(2));for(let n of e)if(t.startsWith(`${n}/`)||t.startsWith(`${n}\\`))return j(r,"remote",`starts with ${n}`),{isLocal:!1};return j(r,"local "),{isLocal:!0,path:t}}var S=class{constructor(e,t){this.data={...e},this.dataKeys=Object.keys(e).filter(s=>!["dynamic","static","location","database_type"].includes(s)),this.dataKeys.push("children"),e.type===c.FUNCTION&&(this.dataKeys.push("static"),this.dataKeys.push("location")),e.type===c.QUERY&&this.dataKeys.push("database_type"),this.data.labels instanceof Set||(this.data.labels=new Set(this.data.labels)),this.children=[],t&&t.children.push(this),p(this,"parent",{value:t}),p(this,"events",{writable:!1,value:[]}),p(this,"id"),p(this,"fqid")}get id(){return this.$hidden.id||(this.$hidden.id=this.buildId().join("")),this.$hidden.id}get name(){return this.data.name}get type(){return this.data.type}get static(){return this.data.static}get location(){return this.data.location}get labels(){return this.data.labels}get events(){return this.$hidden.events}get parent(){return this.$hidden.parent}set parent(e){this.$hidden.parent=e}get locations(){switch(this.type){case c.CLASS:return Array.from(this.classLocations()).sort();case c.FUNCTION:return[this.location];default:return[]}}get packageOf(){return[this,...this.ancestors()].filter(e=>e.type===c.PACKAGE).map(e=>e.name).reverse().join("/")}get classOf(){return[this,...this.ancestors()].filter(e=>e.type===c.CLASS).map(e=>e.name).reverse().join("::")}get classObject(){return[this,...this.ancestors()].find(e=>e.type===c.CLASS)}get packageObject(){return[this,...this.ancestors()].find(e=>e.type===c.PACKAGE)}get functions(){return this.type===c.CLASS?this.children.filter(e=>e.type===c.FUNCTION):this.descendants().filter(e=>e.type===c.FUNCTION)}get classes(){return[this,...this.descendants()].filter(e=>e.type===c.CLASS&&e.functions.length)}visit(e,t=[]){t.push(this),e(this,t),this.children.forEach(s=>s.visit(e,t)),t.pop()}visitAncestors(e){let t=this;for(;t;)e(t),t=t.parent}leafs(){let{type:e}=this,t=[this],s=[];for(;t.length;){let n=t.pop(),i=n.children.filter(o=>o.type===e);i.length&&t.push(...i),(!n.children.length&&n.type===e||i.length!==n.children.length)&&s.push(n)}return s}childLeafs(){return this.children.map(e=>e.leafs()).flat()}buildId(e=[]){return P(this,e)}classLocations(e=new Set){if(this.children.forEach(t=>t.classLocations(e)),this.type===c.FUNCTION&&this.location){let t=this.location.split(":",2);e.add(t[0])}return e}toJSON(){return X(this.dataKeys,this)}static constructDataChainFromEvent(e){let t;if(e.httpServerRequest)t=[{type:c.HTTP,name:"HTTP server requests"},{type:c.ROUTE,name:e.route}];else if(e.httpClientRequest){let n;try{n=new URL(e.httpClientRequest.url).host}catch{n="External service"}t=[{type:c.EXTERNAL_SERVICE,name:n},{type:c.EXTERNAL_ROUTE,name:e.route}]}else e.sqlQuery?t=[{type:c.DATABASE,name:"Database"},{type:c.QUERY,name:e.sqlQuery,database_type:e.sql.database_type}]:t=[{type:c.CLASS,name:e.definedClass},{type:c.FUNCTION,name:e.methodId,static:e.isStatic,location:""}];let s=[...t];for(;s.length;){let n=s.pop();n.dynamic=!0,n.children&&n.children.forEach(i=>s.push(i))}return t}get inboundConnections(){return this.allEvents.filter(e=>e.parent).map(e=>e.parent.codeObject)}get outboundConnections(){return this.allEvents.map(e=>e.children).flat().map(e=>e.codeObject)}get sqlQueries(){return this.allEvents.map(e=>e.children).flat().filter(e=>e.sql).map(e=>e.codeObject)}get prettyName(){switch(this.type){case c.FUNCTION:return`${this.classOf}${this.static?".":"#"}${this.name}`;case c.CLASS:return this.classOf;case c.PACKAGE:return this.packageOf;case c.QUERY:return ie(this.name);default:return this.name}}get fqid(){return this.$hidden.fqid||(this.$hidden.fqid=`${this.type}:${this.id}`),this.$hidden.fqid}get allEvents(){return[this,...this.descendants()].map(e=>e.events).flat()}descendants(){let e=[...this.children],t=[];for(;e.length;){let s=e.pop();t.push(s),e.push(...s.children)}return t}ancestors(){let e=this.parent,t=[];for(;e;)t.push(e),e=e.parent;return t}};function Re(r,e,t){e.push(r),t[r.id]=r}var w=class{constructor(e){this.codeObjectsByLocation={},this.codeObjects=[],this.codeObjectsById={};let t=(s,n=null)=>{let i=new S(s,n);return Re(i,this.codeObjects,this.codeObjectsById),(s.children||[]).forEach(o=>{t(o,i)}),i.type!=="package"&&i.locations.forEach(o=>{let a=this.codeObjectsByLocation[o];a||(a=[],this.codeObjectsByLocation[o]=a),a.push(i)}),i};this.roots=e.map(s=>t(s))}visit(e){this.roots.forEach(t=>t.visit(e))}search(e){let t=e.toLowerCase();return this.codeObjects.filter(s=>s.id.toLowerCase().indexOf(t)!==-1)}codeObjectFromId(e){return this.codeObjectsById[e]}codeObjectsAtLocation(e){return this.codeObjectsByLocation[e]||[]}codeObjectFromEvent(e){let t;if(!(e.httpServerRequest||e.httpClientRequest||e.sql)){let{path:s,lineno:n}=e,i=[s,n].filter(o=>o).join(":");if(i!==""&&(t=this.codeObjectsAtLocation(i).find(a=>a.name===e.methodId),t))return t}return null}root(e){return this.roots.find(t=>t.type===e)}get httpObject(){return this.root(c.HTTP)}get sqlObject(){return this.root(c.DATABASE)}bindEvents(e){if(!e||!Array.isArray(e)||!e.length)return;let t=new Set;e.filter(n=>n.isCall()).forEach(n=>{let i=this.codeObjectFromEvent(n);if(!i){let o=(h,u,E)=>{let d=u.find(x=>x.type===h.type&&x.name===h.name);return d||(d=new S(h,E),E||this.roots.push(d),Re(d,this.codeObjects,this.codeObjectsById)),d},a=S.constructDataChainFromEvent(n),l=null;a.forEach(h=>{l=o(h,l?l.children:this.roots,l)}),i=l}n.codeObject=i,i.events.push(n),i.visitAncestors(o=>t.add(o))}),this.codeObjects=this.codeObjects.filter(n=>t.has(n));function s(n,i){return n.filter(o=>i.has(o)?(o.children=s(o.children,i),!0):!1)}this.roots=s(this.roots,t),Object.keys(this.codeObjectsByLocation).forEach(n=>{t.has(n)||delete this.codeObjectsByLocation[n]}),Object.entries(this.codeObjectsById).forEach(([n,i])=>{t.has(i)||delete this.codeObjectsById[n]})}toJSON(){return this.roots}};var M=class{constructor(e={},t={},s=null,n=[]){this.input=e,this.output=t,this.children=[],this.labels=n,p(this,"caller",{value:s})}get caller(){return this.$hidden.caller}set caller(e){this.$hidden.$hiddencaller=e}clone(){let e={...this.input},t={...this.output},s=[...this.labels],n=new M(e,t,null,s);return this.displayName&&(n.displayName=this.displayName),this.children.forEach(i=>{let o=i.clone();n.addChild(o),o.caller=n}),n}addChild(e){this.children.push(e)}replaceChild(e,t){let s=this.children.indexOf(e);if(s===-1)throw new Error(`${e} not found in call tree`);this.children.splice(s,1,...t),t.forEach(n=>{n.caller=this}),e.caller=null}removeChild(e){let t=this.children.indexOf(e);if(t<0)throw new Error(`${e} found orphaned by ${this} !`);this.children.splice(t,1)}postOrderForEach(e,t=[]){t.push(this),[...this.children].forEach(n=>n.postOrderForEach(e,t)),e(this,t),t.pop(this)}preOrderForEach(e,t=[]){t.push(this),e(this,t),[...this.children].forEach(n=>n.preOrderForEach(e,t)),t.pop(this)}forEach(e){this.postOrderForEach(e)}filter(e){let t=this.clone();return t.forEach((s,n)=>{s.isRoot()||e(s,n)||s.caller.replaceChild(s,s.children)}),t}include(e){let t=this.clone();return t.postOrderForEach((s,n)=>{if(!s.isRoot()){if(s.marked_include&&s.caller){s.caller.marked_include=!0;return}if(s.marked_include=e(s,n),s.marked_include){s.caller&&(s.caller.marked_include=!0);return}s.caller&&s.caller.removeChild(s)}}),t.postOrderForEach(s=>{delete s.marked_include}),t}exclude(e){let t=this.clone();return t.forEach((s,n)=>{s.isRoot()||e(s,n)&&s.caller.removeChild(s)}),t}toArray(){let e=this.children.map(t=>t.toArray()).flat();return this.isRoot()?e:[this,...e]}find(e){if(e(this))return this;for(let t=0;t<this.children.length;t+=1){let s=this.children[t].find(e);if(s)return s}return null}depth(){return this.ancestors().length}ancestors(){let e=[],t=this.caller;for(;t;)e.push(t),t=t.caller;return e}hasAncestor(e){let t=this;for(;t;){if(t===e)return!0;t=t.caller}return!1}descendants(){return[this,...this.children.map(e=>e.descendants()).flat()]}next(){if(this.children.length>0)return this.children[0];let e=this,t=this.caller,s=n=>n===e;for(;t;){let n=t.children.findIndex(s);if(n<0)throw new Error(`${this} found orphaned by ${t}!`);if(n<t.children.length-1)return t.children[n+1];e=t,t=t.caller}return null}previous(){let e=this.caller;if(!e)return null;if(e.children.length===1)return e;let t=e.children.findIndex(s=>s===this);if(t<0)throw new Error(`${this.input.id} found orphaned by ${e.input.id}!`);if(t>0){let s=e.children[t-1];for(;s.children.length>0;)s=s.children[s.children.length-1];return s}return e}left(e){let t=e||this.depth(),s=this;for(;;){let n=s.caller;if(!n)return this;let o=n.children.indexOf(s);if(o!==0){s=n.children[o-1];break}else s=n}for(;s.depth()!==t;){let{children:n}=s;if(n.length===0)break;s=n[n.length-1]}return s}right(e){let t=e||this.depth(),s=this;for(;;){let n=s.caller;if(!n)return this;let i=n.children,o=i.indexOf(s);if(o!==i.length-1){s=n.children[o+1];break}else s=n}for(;s.depth()!==t;){let{children:n}=s;if(n.length===0)break;[s]=n}return s}isRoot(){return this.caller===null}count(){let e=0;return this.forEach(()=>{e+=1}),e}get id(){return this.input&&this.input.id?this.input.id:null}},le=M;function je(r,e){let t=r.listeners[e];return t||(t=[],r.listeners[e]=t),t}var C=class{constructor(){this.listeners={},this.anyListeners=[]}once(e,t){return je(this,e).push({fn:t,once:!0}),this}on(e,t){return je(this,e).push({fn:t}),this}off(e,t){let s=this.listeners[e];if(s){let n=s.filter(i=>i.fn&&i.fn!==t);n.length===0?delete this.listeners[e]:n.length!==s.length&&(this.listeners[e]=n)}return this}emit(e,t=void 0){let s=this.listeners[e];if(s){let n=!1;s.forEach(i=>{i.once&&(n=!0);try{i.fn(t)}catch(o){console.error(`error occurred while executing event ${e}`),console.error(o)}}),n&&(this.listeners[e]=this.listeners[e].filter(i=>!i.once))}return this.anyListeners.forEach(n=>n.emit(e,t)),this}pipe(e,...t){return t.length?(t.forEach(s=>e.on(s,n=>this.emit(n))),this):(e.any(this),this)}any(e){return this.anyListeners.push(e),this}};var N=class extends C{constructor(e,t=()=>[]){super(),this.dataStore={rootEvent:this.rootNode,selectedEvent:this.rootNode},this.rootEvent=new le;let s=[this.rootEvent];return e.forEach(n=>{if(n.event!=="call"){s.length>1&&s.pop();return}let i=s[s.length-1],o=new le(n,n.returnEvent,i,t(n));i.addChild(o),s.push(o)}),this}get rootEvent(){return this.dataStore.rootEvent}set rootEvent(e){this.dataStore.rootEvent=e,this.emit("rootEvent",e)}get selectedEvent(){return this.dataStore.selectedEvent}set selectedEvent(e){this.dataStore.selectedEvent=e,this.emit("selectedEvent",e)}};function Te(r){let e=new Set(r),t=new Set,s=[];return r.forEach(n=>{if(t.has(n))return;t.add(n);let i=[n],o=n;for(;;){let{nextSibling:a}=o;if(a&&e.has(a))i.push(a),t.add(a),o=a;else break}s.push(i)}),s}var O=class{constructor(e){this.data={events:[],classMap:[],...e},this.classMap=new w(this.data.classMap),this.callTree=new N(this.events),this.classMap.bindEvents(this.events),this.labels=qe(this.classMap,this.events);let t;this.events.forEach(s=>{t&&(s.previous=t,t.next=s),t=s}),this.eventsById=this.events.reduce((s,n)=>(s[n.id]=n,s),{}),delete this.data.classMap}get version(){return this.data.version}get metadata(){return this.data.metadata||{}}get name(){return this.metadata.name}get rootEvent(){return this.callTree.rootEvent}get events(){return this.data.events}getEvent(e){return this.eventsById[e]}shallowCopy(){let e=new O({});return e.data.events=this.data.events,e.data.metadata=this.data.metadata,e.classMap=this.classMap,e.callTree=this.callTree,e}rootEvents(){return Se(this.events)}static*multiTreeIterator(e,t){let s,n,i=e.rootEvents(),o=t.rootEvents();for(oe(i,o);;){if(s=i.shift(),n=o.shift(),!s&&!n)return;if(s&&n){let a=s?[...s.children]:[],l=n?[...n.children]:[];oe(a,l),a.forEach(h=>i.push(h)),l.forEach(h=>o.push(h))}yield[s,n]}}static getDiff(e,t){let s={changed:[],added:[],removed:[]},n=O.multiTreeIterator(e,t),i=n.next();for(;!i.done;){let[o,a]=i.value;o?a?o.hash!==a.hash&&s.changed.push([o,a]):s.removed.push(o):s.added.push(a),i=n.next()}return s.added=Te(s.added),s.removed=Te(s.removed),s}toJSON(){return{...this.data,classMap:this.classMap}}};import at from"crypto-js/sha256.js";var $=class{constructor(e){this.hashEntries=[["algorithmVersion",e]]}addProperty(e,t){this.hashEntries.push([e,t])}get canonicalString(){return this.hashEntries.map(e=>e.join("=")).join(`
`)}digest(){return at(this.hashEntries.map(e=>e.join("=")).join("")).toString()}static buildHash(e,t){let s=new $(e);return Object.keys(t).sort().forEach(n=>s.addProperty(n,t[n])),s}};function K(r,e,t){!r||typeof r[e]>"u"||typeof r[t]<"u"||Object.defineProperty(r,t,{get(){return this[e]},enumerable:!1})}var y=class{static contentType(...e){let t=e.find(s=>(s?.headers||{})["Content-Type"]);return t?t.headers["Content-Type"]:null}constructor(e){let t=e;e instanceof y&&(t={...e},e.$hidden.parameters&&(t.parameters=e.$hidden.parameters.map(s=>({...s}))),Array.isArray(e.$hidden.message)&&(t.message=e.$hidden.message.map(s=>({...s}))),e.$hidden.labels&&(t.labels=[...e.$hidden.labels]),e.$hidden.exceptions&&(t.exceptions=[...e.$hidden.exceptions])),this.dataKeys=Object.keys(t),t.event==="call"&&(p(this,"parent"),p(this,"children",{writable:!1,value:[]}),p(this,"dataReferences",{writable:!1,value:[]}),p(this,"codeObject"),p(this,"parameters"),p(this,"message")),p(this,"linkedEvent"),p(this,"labels"),p(this,"exceptions"),p(this,"next"),p(this,"previous"),p(this,"hash"),p(this,"identityHash"),p(this,"depth"),p(this,"sqlQuery"),K(t.http_server_response,"status_code","status"),K(t.http_server_response,"status","status_code"),K(t.http_client_response,"status_code","status"),K(t.http_client_response,"status","status_code"),Object.assign(this,t)}get depth(){if(this.$hidden.depth===void 0){let e=0,{parent:t}=this;for(;t;)e+=1,t=t.parent;this.$hidden.depth=e}return this.$hidden.depth}get methodId(){return this.method_id}get isFunction(){return this.definedClass&&this.methodId}get isStatic(){return this.static}get sql(){return this.callEvent.sql_query}get returnValue(){return this.returnEvent?this.returnEvent.return_value:void 0}get elapsedTime(){return this.returnEvent?this.returnEvent.elapsed:void 0}get elapsedInstrumentationTime(){return this.returnEvent?this.returnEvent.elapsed_instrumentation:void 0}get linkedEvent(){return this.$hidden.linkedEvent}get next(){return this.$hidden.next}get previous(){return this.$hidden.previous}get parent(){return this.$hidden.parent}get children(){return this.$hidden.children||[]}get codeObject(){return this.callEvent.$hidden.codeObject}get parameters(){return this.callEvent.$hidden.parameters}get labels(){let e=this.callEvent.$hidden.labels||[];return new Set([...e,...this.callEvent.codeObject.labels])}get exceptions(){return this.returnEvent?this.returnEvent.$hidden.exceptions||[]:[]}get message(){return this.callEvent.$hidden.message}get httpServerRequest(){return this.callEvent.http_server_request}get httpServerResponse(){return this.returnEvent?this.returnEvent.http_server_response:void 0}get httpClientRequest(){return this.callEvent.http_client_request}get httpClientResponse(){return this.returnEvent?this.returnEvent.http_client_response:void 0}get definedClass(){return this.defined_class?this.defined_class.replace(/\./g,"/"):null}get requestPath(){return this.httpServerRequest?this.httpServerRequest.normalized_path_info||this.httpServerRequest.path_info:this.httpClientRequest?this.httpClientRequest.url:null}get requestMethod(){return this.httpServerRequest?this.httpServerRequest.request_method:this.httpClientRequest?this.httpClientRequest.request_method:null}get requestContentType(){return y.contentType(this.httpServerRequest,this.httpClientRequest)}get responseContentType(){return y.contentType(this.httpServerResponse,this.httpClientResponse)}get route(){let{requestMethod:e,requestPath:t}=this;return!e||!t?null:`${e} ${t}`}get sqlQuery(){if(!this.$hidden.sqlQuery){let{sql:e}=this;this.$hidden.sqlQuery=e?e.normalized_sql||e.sql:null}return this.$hidden.sqlQuery}get fqid(){return`event:${this.id}`}get previousSibling(){let{parent:e}=this;if(!e)return null;let t=e.children.findIndex(s=>s===this);return console.assert(t!==-1,"attempted to locate index of an orphaned event"),t===0?null:e.children[t-1]}get nextSibling(){let{parent:e}=this;if(!e){let s=this.next;for(;s;){if(s.isCall()&&!s.parent)return s;s=s.next}return null}let t=this.parent.children.findIndex(s=>s===this);return console.assert(t!==-1,"attempted to locate index of an orphaned event"),t===e.children.length-1?null:e.children[t+1]}set codeObject(e){q(this.$hidden,"codeObject")&&(this.$hidden.codeObject=e)}set parameters(e){q(this.$hidden,"parameters")&&(this.$hidden.parameters=e)}set labels(e){q(this.$hidden,"labels")&&(this.$hidden.labels=e)}set exceptions(e){q(this.$hidden,"exceptions")&&(this.$hidden.exceptions=e)}set message(e){q(this.$hidden,"message")&&(this.$hidden.message=e)}set linkedEvent(e){this.$hidden.linkedEvent=e}set next(e){this.$hidden.next=e}set previous(e){this.$hidden.previous=e}set parent(e){this.$hidden.parent=e}link(e){e.linkedEvent||this.linkedEvent||(e.linkedEvent=this,this.linkedEvent=e)}isCall(){return this.event==="call"}isReturn(){return this.event==="return"}get threadId(){return this.thread_id}get parentId(){return this.returnEvent?this.returnEvent.parent_id:void 0}get callEvent(){return this.isCall()?this:this.$hidden.linkedEvent}get returnEvent(){return this.isReturn()?this:this.$hidden.linkedEvent}get identityHash(){return this.$hidden.identityHash||(this.$hidden.identityHash=this.buildIdentityHash().digest()),this.$hidden.identityHash}get hash(){return this.$hidden.hash||(this.$hidden.hash=this.buildStableHash().digest()),this.$hidden.hash}get stableProperties(){return this.$hidden.stableProperties||(this.$hidden.stableProperties=this.gatherStableProperties()),this.$hidden.stableProperties}callStack(){let e=this.ancestors().reverse();return e.push(this.callEvent),e}ancestors(){let e=[],t=this.callEvent.parent;for(;t;)e.push(t),t=t.parent;return e}descendants(){let e=[],t=[...this.children];for(;t.length;){let s=t.pop();s.children.forEach(n=>t.push(n)),e.push(s)}return e}traverse(e){let t=this,s=this.nextSibling,{onEnter:n}=e,{onExit:i}=e;for(typeof e=="function"&&(n=e,i=e);t&&(t.isCall()&&n?n(t):t.isReturn()&&i&&i(t),t=t.next,!(!t||t===s)););}dataObjects(){return[this.parameters,this.message,this.returnValue].flat().filter(Boolean)}get qualifiedMethodId(){let{definedClass:e,isStatic:t,methodId:s}=this;if(!!e)return`${e}${t?".":"#"}${s}`}toJSON(){return X(this.dataKeys,this)}toString(){let{sqlQuery:e}=this;if(e)return e;let{route:t}=this;return t||this.qualifiedMethodId}gatherIdentityProperties(){if(this.httpServerRequest)return{event_type:"http_server_request",route:this.route};if(this.httpClientRequest)return{event_type:"http_client_request",route:this.route};let{sqlQuery:e}=this;if(e){let t=L(e);return t?{event_type:"sql",actions:[...new Set(t.actions)].sort(),tables:[...new Set(t.tables)].sort()}:{event_type:"sql",sql_normalized:A(e,this.sql.database_type)}}return{event_type:"function",id:this.codeObject.id}}gatherStableProperties(e){let{sqlQuery:t}=this,s=o=>Object.fromEntries(Object.entries(o).map(([a,l])=>[a,l??""])),n=o=>Object.assign(o,{route:this.route,status_code:this.httpServerResponse?.status||this.httpServerResponse?.status_code||this.httpClientResponse?.status||this.httpServerResponse?.status_code}),i;if(t){let o,a=`${this.sql.database_type}:${t}`;e&&(o=e.get(a)),o||(o=se(t,this.sql.database_type).split(/{"type":"variable"}(?:,{"type":"variable"})*/g).join('{"type":"variable"}'),e&&e.set(a,o)),i={event_type:"sql",sql_normalized:o}}else this.httpServerRequest?i=n({event_type:"http_server_request"}):this.httpClientRequest?i=n({event_type:"http_client_request"}):i={event_type:"function",id:this.codeObject.id,raises_exception:this.exceptions.length>0};return s(i)}buildIdentityHash(){return $.buildHash("event-identity-v2",this.gatherIdentityProperties())}buildStableHash(e){return $.buildHash("event-stable-properties-v2",this.gatherStableProperties(e))}};var z=class{constructor(e){this.events=[],this.stack=[],this.id=e,this.eventMap={}}add(e){if(e.isCall())this.stack.push(e),this.eventMap[e.id]=e;else{if(typeof e.parent_id>"u"){let s=this.stack[this.stack.length-1];if(s&&s.defined_class===e.defined_class&&s.method_id===e.method_id&&s.path===e.path&&s.static===e.static)e.parent_id=s.id;else return}let t=this.eventMap[e.parent_id];if(t){t.link(e),this.stack.pop();let s=this.stack[this.stack.length-1];s&&(s.children.push(t),t.parent=s)}else return}this.events.push(e)}unwound(){return this.events.length>0&&this.stack.length===0}};function ot(r){return Object.keys(r.activeStacks).length+r.finalizedStacks.length}var H=class{constructor(){this.activeStacks={},this.finalizedStacks=[]}add(e){let t=this.activeStacks[e.thread_id];if(!t){let s=ot(this);t=new z(s),this.activeStacks[e.thread_id]=t}t.add(e),t.unwound()&&(this.finalizedStacks.splice(t.id,0,t.events),delete this.activeStacks[e.thread_id])}size(){let e=k(Object.values(this.activeStacks));return e+=k(this.finalizedStacks),e}collect(){let e=[...this.finalizedStacks];return Object.values(this.activeStacks).forEach(t=>e.splice(t.id,0,t.events)),e.reduce((t,s)=>{if(s.length===0)return t;if(t.length===0)return t.push([s]),t;if(s[0].http_server_request)return t.push([s]),t;if(s[0].http_client_request)return t.push([s]),t;let n=t[t.length-1],i=n[n.length-1];return i[0].http_server_request||i[0].http_client_request?t.push([s]):n.push(s),t},[])}};var he=(r,e,...t)=>r.reduce((s,n)=>n(s,...t),e),ce=class extends C{constructor(e){super(),this.sorter=new H,this.transforms={event:[],stack:[],chunk:[]},this.allEvents=[],e&&this.source(e)}source(e){let t=typeof e;if(t==="object")this.data={...e};else if(t==="string")this.data=JSON.parse(e);else throw new Error(`got invalid type ${t}, expected object or string`);return this.exclusions=new Set,(this.data.events||[]).forEach(s=>{this.data.eventUpdates&&this.data.eventUpdates[s.id]&&(s=this.data.eventUpdates[s.id]);let n=new y(s);this.allEvents.push(n),this.sorter.add(n)}),delete this.data.events,delete this.data.eventUpdates,this}event(e){return console.assert(typeof e=="function"),this.transforms.event.push(e),this}stack(e){return console.assert(typeof e=="function"),this.transforms.stack.push(e),this}chunk(e){return console.assert(typeof e=="function"),this.transforms.chunk.push(e),this}normalize(){if(/^https?/.test(this.data.metadata?.git?.repository)){let t=new URL(this.data.metadata.git.repository);t.username="",t.password="",this.data.metadata.git.repository=t.toString()}let e=1;return this.event(t=>{t.id=e,e+=1,t.isCall()&&t.returnEvent&&(t.returnEvent.parent_id=t.id);let{httpServerRequest:s}=t;return s&&s.normalized_path_info&&(s.normalized_path_info=s.normalized_path_info.toString()),s&&s.path_info&&(s.path_info=s.path_info.toString()),t}),this.stack(t=>(t.filter(s=>s.isCall()&&!s.returnEvent).reverse().map(s=>{let n=new y({event:"return",thread_id:s.thread_id,parent_id:s.id});return n.link(s),n}).forEach(s=>t.push(s)),t))}prune(e){console.assert(typeof e=="number");let t,s=0;return this.on("preprocess",n=>{let i=this.sorter.size();t=new w(n.data.classMap),s=Math.min(e/i,1),t.visit(l=>{l.size=0,l.count=0}),this.allEvents.forEach(l=>{if(l.event!=="call"||l.sql_query||l.http_server_request||l.http_client_request)return;let h=t.codeObjectFromEvent(l);if(h){let u=k(l);h.size=h.size+u||u,h.count=h.count+1||1}});let o=0,a=t.codeObjects.filter(l=>l.size).sort((l,h)=>l.size-h.size).map(l=>(o+=l.size,{fqid:l.fqid,count:l.count,size:l.size,totalBytes:o})).reverse();for(let l=0;l<a.length;l+=1){let h=a[l];if(h.totalBytes<=o*s)break;this.exclusions.add(h.fqid)}this.updatePruneFilter()}).chunk(n=>this.excludeEvents(n,t,this.exclusions))}updatePruneFilter(){let e=Array.from(this.exclusions.values());this.data.pruneFilter?this.data.pruneFilter.hideName?e.forEach(t=>this.data.pruneFilter.hideName.push(t)):this.data.pruneFilter.hideName=e:this.data.pruneFilter={hideName:e}}excludeEvents(e,t,s){return e.map(n=>n.filter(i=>{let{callEvent:o}=i;if(!o)return!1;if(o.http_server_request||o.http_client_request||o.sql_query)return!0;let a=t.codeObjectFromEvent(o);return!a||!a.fqid?!0:!s.has(a.fqid)}))}removeNoise(){return this.data.events?Boolean(this.data.events.find(t=>t.httpServerRequest||t.httpClientRequest))?this.chunk(t=>t.filter(s=>s.length?Boolean(s[0].httpServerRequest)||Boolean(s[0].httpClientRequest):!1)):this:this}collectEvents(){return this.sorter.collect().map(e=>he(this.transforms.chunk,e).map(s=>he(this.transforms.stack,s).map(i=>he(this.transforms.event,i)))).flat(2)}build(){this.emit("preprocess",{data:this.data});let e=this.collectEvents();return new O({...this.data,events:e})}};function V(r=null){return new ce(r)}var _=class{constructor(e){this.event=e}get callEvent(){return this.event.callEvent}get labels(){let{codeObject:e}=this.event;return e&&e.labels?e.labels:null}*self(){yield this}*ancestors(){let e=this.callEvent.parent;for(;e;)yield new _(e),e=e.parent}*preceding(){for(let e of[this,...this.ancestors()]){e!==this&&(yield e);for(let t of e.precedingSiblings()){for(let s of[...t.descendants()].reverse())yield s;yield t}}}*following(){for(let e of this.descendants())yield e;for(let e of[this,...this.ancestors()])for(let t of e.followingSiblings()){yield t;for(let s of t.descendants())yield s}}*precedingSiblings(){let{parent:e}=this.callEvent;if(!e)return;let t=e.children.indexOf(this.callEvent);for(let s=t-1;s>=0;s-=1)yield new _(e.children[s])}*followingSiblings(){let{parent:e}=this.callEvent;if(!e)return;let t=e.children.indexOf(this.callEvent);for(let s=t+1;s<e.children.length;s+=1)yield new _(e.children[s])}*descendants(e=()=>!0){let t=[...this.event.children];for(;t.length;){let s=t.shift();e(s)&&(yield new _(s),s.children&&t.unshift(...s.children))}}hasLabel(e){return this.hasLabels([e])}hasLabels(...e){return this.labels?!e||!e.length?this.labels.size>0:e.filter(t=>this.labels.has(t)).length===e.length:!1}};function Ae(r,e){return e.type==="function"&&(r[e.location]=e),e.children&&e.children.reduce(Ae,r),r}var W=class{constructor(e){this.functionObjects=e.reduce(Ae,{})}getName(e){let t=ae(e);if(t)return t;let s=this.getCodeObject(e);if(s)return s.display_name;let n=e.static?".":"#";return[e.defined_class,n,e.method_id].join("")}getLabels(e){let t=[];e.labels&&t.push(...e.labels);let s=this.getCodeObject(e);return s&&s.labels.length&&t.push(...s.labels),t}getCodeObject(e){return this.functionObjects[`${e.path}:${e.lineno}`]}};var Ee=1,R=class{constructor(e=!0,t=!0){m(this,"on",!0);m(this,"default",!0);this.on=e,this.default=t}},Q=class extends R{constructor(t=!0,s=!0,n=Q.DEFAULT_TIME){super(t,s);m(this,"DEFAULT_TIME",100);m(this,"time",this.DEFAULT_TIME);this.time=n}},B=class extends R{constructor(t=!0,s=!0,n=[]){super(t,s);m(this,"names",[]);this.names=n}},pe=class extends B{constructor(t=!0,s=!0,n=[],i=void 0){super(t,s,n);m(this,"depth",Ee);i!==void 0&&(this.depth=i)}},de=["vendor","node_modules"],me=class extends R{constructor(t=!1,s=!1,n=de){super(t,s);m(this,"dependencyFolders",de);this.dependencyFolders=n||de}},lt=["cli.command","job.perform","message.handle"],ge=class{constructor(){m(this,"limitRootEvents",new R);m(this,"hideMediaRequests",new R);m(this,"hideExternalPaths",new me);m(this,"hideUnlabeled",new R(!1,!1));m(this,"hideElapsedTimeUnder",new Q(!1,!1,1));m(this,"hideName",new B(!1,!1,[]));m(this,"hideTree",new B(!1,!1,[]));m(this,"context",new pe(!1,!1,[]))}},ue={};function fe(r,e){return ue[r]||(ue[r]=new RegExp(...e())),ue[r]}function be(r,e,t){let s=new Set;r.filter(i=>i.isCall()&&e(i)).forEach(i=>s.add(i));let n=(i,o)=>{s.has(i)||t!==void 0&&o>t||(s.add(i),i.children&&i.children.forEach(a=>n(a,o+1)))};return[...s].filter(i=>i.children).forEach(i=>i.children.forEach(o=>n(o,1))),[...s].forEach(i=>s.add(i.returnEvent)),s}function Le(r,e,t){let s=be(r,e);return t||s.size?r.filter(n=>s.has(n)):r}function ht(r,e){let t=be(r,e);return r.filter(s=>!t.has(s))}var v=class{constructor(){m(this,"rootObjects",[]);m(this,"declutter",new ge)}filter(e,t){let{classMap:s}=e,{events:n}=e;function i(a,l,h){return s.codeObjects.reduce((u,E)=>(a.some(d=>v.codeObjectIsMatched(E,d,h))&&E.visit(d=>{(d!==E||l)&&u.add(d)}),u),new Set)}if(this.declutter.limitRootEvents.on&&(n=Le(n,l=>{if(l.httpServerRequest)return!0;let{labels:h}=l.codeObject;return lt.find(u=>h.has(u))},!1)),this.rootObjects.length){let a=i(this.rootObjects,!0);n=Le(n,h=>a.has(h.codeObject),!0)}if(this.declutter.context.on&&this.declutter.context.names.length){let a=i(this.declutter.context.names,!0,!1),l=d=>a.has(d.codeObject),h=be(n,l,this.declutter.context.depth),u=new Set,E=(d,x=1)=>{!d||u.has(d)||((x<=this.declutter.context.depth||!d.parent)&&(u.add(d),u.add(d.returnEvent)),d.parent&&E(d.parent,x+1))};n.filter(d=>l(d)).forEach(d=>E(d.parent)),n=n.filter(d=>h.has(d)||u.has(d))}if(this.declutter.hideTree.on&&this.declutter.hideTree.names.length){let a=i(this.declutter.hideTree.names,!1);n=ht(n,l=>a.has(l.codeObject))}if(this.declutter.hideMediaRequests.on&&(n=v.filterMediaRequests(n)),this.declutter.hideUnlabeled.on&&(n=n.filter(a=>a.labels.size>0||a.codeObject.type!=="function")),this.declutter.hideExternalPaths.on&&(n=n.filter(a=>a.codeObject.type!=="function"||$e(a.codeObject.location,this.declutter.hideExternalPaths.dependencyFolders).isLocal)),this.declutter.hideElapsedTimeUnder.on&&this.declutter.hideElapsedTimeUnder.time>0&&(n=n.filter(a=>a.elapsedTime&&a.elapsedTime>=this.declutter.hideElapsedTimeUnder.time/1e3)),this.declutter.hideName.on&&this.declutter.hideName.names.length){let a=i(this.declutter.hideName.names,!0);n=n.filter(l=>!a.has(l.codeObject))}let o=new Set(n.filter(a=>a.isCall()).map(a=>a.id));return t&&t.length>0&&(t.forEach(a=>{a.appMapUri&&a.appMapUri.fragment&&typeof a.appMapUri.fragment=="string"&&(a.appMapUri.fragment=JSON.parse(a.appMapUri.fragment))}),n=v.attachFindingsToEvents(n,t)),V({events:n.filter(a=>o.has(a.id)||a.parentId&&o.has(a.parentId)),classMap:s.roots.map(a=>({...a.data})),metadata:e.metadata}).build()}static filterMediaRequests(e){let t=[],s=["application/javascript","application/ecmascript","audio/.+","font/.+","image/.+","text/javascript","text/ecmascript","text/css","video/.+"].map(i=>new RegExp(i,"i")),n=new Set(["aac","avi","bmp","css","flv","gif","htm","html","ico","jpeg","jpg","js","json","jsonld","mid","midi","mjs","mov","mp3","mp4","mpeg","oga","ogg","ogv","ogx","opus","otf","png","svg","tif","tiff","ts","ttf","wav","weba","webm","webp","woff","woff2","xhtml","3gp","3g2"]);return e.forEach(i=>{let{httpServerResponse:o}=i;if(i.requestMethod==="GET"&&i.requestPath){let a=i.requestPath.match(/.*\.([\S]*)$/);a&&n.has(a[1])&&t.push(i.id)}else if(o){let a,{headers:l}=o;if(l){let h=Object.keys(l).filter(u=>u.toLowerCase()==="content-type")[0];a=l[h]}else a=o.mime_type;a&&i.parentId&&s.some(h=>h.test(a))&&t.push(i.parentId)}}),e.filter(i=>!t.includes(i.id))}static codeObjectIsMatched(e,t,s){if(t===e.fqid)return!0;if(t.startsWith("label:")){let n=fe(t,()=>[`^${t.replace("label:","").replace("*",".*")}$`,"ig"]);return Array.from(e.labels).some(i=>n.test(i))}if(t.length>2&&t.charAt(0)==="/"&&t.charAt(t.length-1)==="/"){if(fe(t,()=>[t.substring(1,t.length-1),"ig"]).test(e.fqid))return!0}else if(s&&t.endsWith("*")&&fe(t,()=>[`^${t.slice(0,t.length-1)}.*`,"ig"]).test(e.fqid))return!0;return!1}static attachFindingsToEvents(e,t){let s=e.reduce((n,i)=>(n[i.id]=i.callEvent,n),{});return t.forEach(n=>{let i=n.appMapUri&&n.appMapUri.fragment&&n.appMapUri.fragment.traceFilter;i&&i.split(" ").map(a=>Number(a.split(":")[1])).forEach(a=>{let l=s[a];l&&!v.eventAlreadyHasFinding(l,n)&&(l.findings?l.findings.push(n):l.findings=[n])})}),e}static eventAlreadyHasFinding(e,t){return e.findings&&!!e.findings.find(s=>s.finding.hash_v2===t.finding.hash_v2)}};function ye(r,e){if(r===!1&&e===!1)return!1;let t=[...new Set([...r||[],...e||[]])].sort();return t.length>0?t:!1}function ct(...r){return r=r.filter(e=>e!=null&&e!==!1),r.length===0?!1:Math.min(...r.map(e=>typeof e=="number"?e:parseInt(e.toString(),10)).filter(e=>!isNaN(e)))}function Y(...r){return r.find(e=>e!=null&&e!==!1)}function dt(r,e){return{rootObjects:ye(r.rootObjects,e.rootObjects),limitRootEvents:Y(r.limitRootEvents,e.limitRootEvents),hideMediaRequests:Y(r.hideMediaRequests,e.hideMediaRequests),hideUnlabeled:Y(r.hideUnlabeled,e.hideUnlabeled),hideExternal:Y(r.hideExternal,e.hideExternal),dependencyFolders:ye(r.dependencyFolders,e.dependencyFolders),hideElapsedTimeUnder:ct(r.hideElapsedTimeUnder,e.hideElapsedTimeUnder),hideName:ye(r.hideName,e.hideName)}}function ut(r){if(!r)return{};let e=r,t=r.rootObjects;return"declutter"in r&&(e=r.declutter),Object.entries({rootObjects:t,limitRootEvents:e.limitRootEvents.on,hideMediaRequests:e.hideMediaRequests.on,hideUnlabeled:e.hideUnlabeled.on,hideExternalPaths:e.hideExternalPaths.on?e.hideExternalPaths.dependencyFolders:!1,hideElapsedTimeUnder:e.hideElapsedTimeUnder.on?e.hideElapsedTimeUnder.time:!1,context:e.context.on?e.context.names:!1,contextDepth:e.context.on&&e.context.depth!==Ee?e.context.depth:!1,hideName:e.hideName.on?e.hideName.names:!1}).reduce((s,[n,i])=>{let o=e[n];return(Array.isArray(i)&&i.length!==0||typeof i=="number"||o&&o.default!==i)&&(s[n]=i),s},{})}function Ne(r){if(!r)return;let e;return r.trimStart().startsWith("{")?e=r:e=Ce(r),JSON.parse(e)}function ft(r){typeof r=="string"&&(r=Ne(r));let e=new v;if(!r)return e;for(let t in r)Object.prototype.hasOwnProperty.call(r,t)&&r[t]===void 0&&delete r[t];return"rootObjects"in r&&r.rootObjects!==!1&&(e.rootObjects=r.rootObjects),"limitRootEvents"in r&&(e.declutter.limitRootEvents.on=r.limitRootEvents),"hideMediaRequests"in r&&(e.declutter.hideMediaRequests.on=r.hideMediaRequests),"hideUnlabeled"in r&&(e.declutter.hideUnlabeled.on=r.hideUnlabeled),["hideExternal","hideExternalPaths"].forEach(t=>{if(t in r){let s=r[t];s&&Array.isArray(s)?(e.declutter.hideExternalPaths.on=!0,e.declutter.hideExternalPaths.dependencyFolders=r[t]):e.declutter.hideExternalPaths.on=r[t]}}),"dependencyFolders"in r&&r.dependencyFolders!==!1&&(e.declutter.hideExternalPaths.dependencyFolders=r.dependencyFolders),"hideElapsedTimeUnder"in r&&r.hideElapsedTimeUnder!==!1&&(e.declutter.hideElapsedTimeUnder.on=!0,e.declutter.hideElapsedTimeUnder.time=r.hideElapsedTimeUnder),["hideName","hideNames"].forEach(t=>{t in r&&r[t]!==!1&&(e.declutter.hideName.on=!0,e.declutter.hideName.names=r[t])}),"context"in r&&r.context!==!1&&(e.declutter.context.on=!0,e.declutter.context.names=r.context,"contextDepth"in r&&r.contextDepth!==!1&&(e.declutter.context.depth=r.contextDepth)),"hideTree"in r&&r.hideTree!==!1&&(e.declutter.hideTree.on=!0,e.declutter.hideTree.names=r.hideTree),e}export{O as AppMap,v as AppMapFilter,N as CallTree,w as ClassMap,S as CodeObject,c as CodeObjectType,y as Event,W as EventInfo,_ as EventNavigator,C as EventSource,se as abstractSqlAstJSON,p as addHiddenProperty,L as analyzeSQL,Ce as base64UrlDecode,kt as base64UrlEncode,V as buildAppMap,qe as buildLabels,Ze as capitalizeString,P as codeObjectId,ft as deserializeFilter,Ne as filterStringToFilterState,It as fullyQualifiedFunctionName,et as getHttpLabel,ae as getLabel,Pt as getRepositoryUrl,Se as getRootEvents,st as getSqlLabel,ie as getSqlLabelFromString,q as hasProp,rt as hashify,Ut as identityHashEvent,Nt as isCommand,Lt as isFalsey,$e as isLocalPath,dt as mergeFilterState,A as normalizeSQL,U as parseSQL,oe as resolveDifferences,ut as serializeFilter,Xe as setSQLErrorHandler,k as sizeof,Ft as tokenizeIdentifier,X as transformToJSON};
//# sourceMappingURL=index.js.map