"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const models_1 = require("@appland/models");
const async_1 = require("async");
const promises_1 = require("fs/promises");
const analyzeAppMaps_1 = __importDefault(require("./analyzeAppMaps"));
const buildDiagram_1 = __importDefault(require("@appland/sequence-diagram/dist/buildDiagram"));
async function buildDiagrams(appmapDir, codeObjectPatterns) {
    const { appmaps, specification } = await (0, analyzeAppMaps_1.default)(appmapDir, codeObjectPatterns);
    const diagrams = [];
    const diagramQueue = (0, async_1.queue)(async (appmapFile) => {
        const appmapData = JSON.parse(await (0, promises_1.readFile)([appmapFile, 'appmap.json'].join('.'), 'utf-8'));
        const appmap = (0, models_1.buildAppMap)().source(appmapData).build();
        diagrams.push({
            appmapFile,
            diagram: (0, buildDiagram_1.default)([appmapFile, 'appmap.json'].join('.'), appmap, specification),
        });
    }, 2);
    for (const appmap of appmaps)
        diagramQueue.push(appmap);
    diagramQueue.error((err) => console.warn(err));
    if (!diagramQueue.idle())
        await diagramQueue.drain();
    return diagrams;
}
exports.default = buildDiagrams;
//# sourceMappingURL=buildDiagrams.js.map