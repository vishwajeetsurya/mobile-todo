"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const assert_1 = __importDefault(require("assert"));
const worker_threads_1 = require("worker_threads");
(0, assert_1.default)(worker_threads_1.parentPort);
const models_1 = require("@appland/models");
const sqlErrorLog_1 = __importDefault(require("../../lib/sqlErrorLog"));
const utils_1 = require("../../utils");
const promises_1 = require("fs/promises");
const analyzeTask_1 = require("./analyzeTask");
(0, models_1.setSQLErrorHandler)(sqlErrorLog_1.default);
worker_threads_1.parentPort.on('message', async (task) => {
    (0, assert_1.default)(worker_threads_1.parentPort);
    if (task.verbose)
        (0, utils_1.verbose)(task.verbose);
    try {
        const stats = await (0, promises_1.stat)(task.appmapFile);
        if (stats.size > task.maxSize) {
            worker_threads_1.parentPort.postMessage({ oversized: true });
            return;
        }
        const result = await (0, analyzeTask_1.analyzeTask)(task);
        if (result)
            worker_threads_1.parentPort.postMessage({ result });
    }
    catch (err) {
        worker_threads_1.parentPort.postMessage({ error: err });
    }
});
//# sourceMappingURL=analyzeWorker.js.map