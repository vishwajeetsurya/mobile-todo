"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const errors_1 = require("./errors");
const utils_1 = require("../utils");
const userInteraction_1 = __importDefault(require("./userInteraction"));
const chalk_1 = __importDefault(require("chalk"));
const exitCode_1 = require("./record/types/exitCode");
const telemetry_1 = __importDefault(require("../telemetry"));
async function runCommand(commandPrefix, fn) {
    try {
        const ret = await fn();
        process.exitCode = 0;
        return ret;
    }
    catch (err) {
        if (err instanceof errors_1.ValidationError) {
            console.warn(err.message);
            process.exitCode = exitCode_1.ExitCode.Error;
        }
        else if (err instanceof errors_1.AbortError) {
            process.exitCode = exitCode_1.ExitCode.Quit;
        }
        else if (err instanceof Error) {
            telemetry_1.default.sendEvent({
                name: `${commandPrefix}:error`,
                properties: {
                    errorMessage: err.message,
                    errorStack: err.stack,
                },
            });
            if ((0, utils_1.verbose)()) {
                userInteraction_1.default.error(err);
            }
            else {
                userInteraction_1.default.error(`An error occurred: ${err.toString().split('\n')[0]}`);
                userInteraction_1.default.error(`Try re-running the command with the ${chalk_1.default.red('verbose')} flag (${chalk_1.default.red('-v')}).`);
            }
            process.exitCode = exitCode_1.ExitCode.Error;
        }
        else {
            // You'll wind up here if the object thrown wasn't an instance of Error. An obvious way this
            // can happen is `throw 'Fail'`. A less obvious way is rejecting a Promise with something
            // other than an error, e.g. `reject('Fail')`.
            throw err;
        }
    }
}
exports.default = runCommand;
//# sourceMappingURL=runCommand.js.map