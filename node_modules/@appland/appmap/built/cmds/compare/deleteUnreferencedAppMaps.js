"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const promises_1 = require("fs/promises");
const RevisionName_1 = require("../../diffArchive/RevisionName");
const utils_1 = require("../../utils");
const ui_1 = require("./ui");
const console_1 = require("console");
async function deleteUnreferencedAppMaps(paths, referencedAppMaps) {
    const deleteAppMap = async (revisionName, appmap) => {
        if ((0, utils_1.verbose)())
            console.log((0, ui_1.mutedStyle)(`AppMap ${revisionName}/${appmap} is unreferenced so it will be deleted.`));
        const appmapPath = paths.appmapPath(revisionName, appmap);
        const appmapIndexDir = appmapPath.slice(0, -'.appmap.json'.length);
        await (0, promises_1.rm)(appmapPath);
        await (0, promises_1.rm)(appmapIndexDir, { recursive: true });
    };
    for (const revisionName of [RevisionName_1.RevisionName.Base, RevisionName_1.RevisionName.Head]) {
        for (const appmap of await paths.appmaps(revisionName)) {
            if (!referencedAppMaps(revisionName, appmap))
                try {
                    await deleteAppMap(revisionName, appmap);
                }
                catch (err) {
                    (0, console_1.warn)(`Failed to delete unreferenced AppMap ${revisionName}/${appmap}. Will continue...`);
                }
        }
    }
}
exports.default = deleteUnreferencedAppMaps;
//# sourceMappingURL=deleteUnreferencedAppMaps.js.map